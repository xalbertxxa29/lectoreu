<!DOCTYPE html>
<html lang="es">
<head>
  <meta name="theme-color" content="#000000" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Control de Marcación</title>

  <link rel="stylesheet" href="style.css" />
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">


  <!-- Estilos adicionales -->
  <style>
    .hidden{display:none}
    .questions{margin:10px 0 14px 20px;padding:0}
    .questions li{margin:8px 0 10px;line-height:1.35}
    .questions label{margin-left:10px;margin-right:8px;user-select:none}
    .evidence-preview img{max-width:160px;max-height:160px;border-radius:10px;object-fit:cover}

    /* === Mensaje de permisos de cámara === */
    #camera-permission-msg {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.55);
      z-index: 9999;
      text-align: center;
      padding: 20px;
    }
    #camera-permission-msg.active { display: flex; }
    #camera-permission-msg .msg-box {
      background: #fff;
      color: #111;
      padding: 24px 30px;
      border-radius: 14px;
      max-width: 400px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);
      font-family: system-ui, Arial, sans-serif;
    }
    #camera-permission-msg h3 {
      margin: 0 0 12px;
      color: #111;
      letter-spacing: .5px;
    }
    #camera-permission-msg p {
      margin: 10px 0 0;
      font-size: 15px;
      line-height: 1.5;
      color:#444;
    }
    /* Botón PLAY */
    #camera-permission-msg .btn-play{
      display:inline-flex; align-items:center; gap:10px;
      border:none; border-radius:999px; cursor:pointer;
      padding:14px 22px; font-weight:800; letter-spacing:.3px;
      background:#3b82f6; color:#fff; box-shadow:0 12px 32px rgba(59,130,246,.35);
      transition: transform .06s ease, box-shadow .18s ease;
      margin-top: 6px;
    }
    #camera-permission-msg .btn-play:active{ transform: scale(.98); }
    #camera-permission-msg .btn-play:hover{ box-shadow:0 16px 42px rgba(59,130,246,.45); }
    #camera-permission-msg .hint{
      margin:12px 0 0; font-size:13px; color:#6b7280;
    }
  </style>

  <!-- Librería QR -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js" defer></script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js" defer></script>
  <!-- Tu config: debe definir window.firebaseConfig -->
  <script src="firebase-config.js" defer></script>

  <!-- Tu lógica -->
  <script src="script.js" defer></script>
</head>
<body>
  <!-- Cámara / Scanner -->
  <div id="scanner-container">
    <video id="video" playsinline></video>
    <div id="scan-box-overlay"></div>
    <div class="scanner-header">Apunte al código QR</div>
  </div>

  <!-- Canvas oculto -->
  <canvas id="canvas" hidden></canvas>

  <!-- Modal tras escanear -->
  <div id="options-container" class="modal-container" style="display:none;">
    <div class="modal-content">
      <h3>Punto de Marcación</h3>
      <p id="scanned-point-name">—</p>
      <div class="button-group">
        <button id="btn-con-novedad" class="btn-novedad btn btn-warn">CON NOVEDAD</button>
        <button id="btn-sin-novedad" class="btn-normal btn btn-primary">SIN NOVEDAD</button>
      </div>
      <button id="btn-cancel-scan" class="btn-cancel btn">Cancelar</button>
    </div>
  </div>

  <!-- Formulario SIN NOVEDAD -->
  <div id="form-sin-novedad-container" class="modal-container" style="display:none;">
    <div class="modal-content">
      <h3>Registro Sin Novedad</h3>
      <p>Punto: <strong id="point-name-sin-novedad"></strong></p>
      <form id="form-sin-novedad">
        <input type="text" id="agent-name-sin-novedad" placeholder="Ingrese su Nombre y Apellido" required />
        <button type="submit" class="btn-submit btn btn-primary">Aceptar y Guardar</button>
        <button type="button" class="btn-cancel form-cancel btn">Cancelar</button>
      </form>
    </div>
  </div>

  <!-- Formulario CON NOVEDAD -->
  <div id="form-con-novedad-container" class="modal-container" style="display:none;">
    <div class="modal-content">
      <h3>Registro Con Novedad</h3>
      <p>Punto: <strong id="point-name-con-novedad"></strong></p>
      <form id="form-con-novedad">
        <input type="text" id="agent-name-con-novedad" placeholder="Ingrese su Nombre y Apellido" required />
        <textarea id="observation-text" placeholder="Describa la observación aquí..." rows="4" required></textarea>

        <ol class="questions">
          <li class="q-item">
            <p class="q-text">¿El agente cuenta con todos sus EPPs reglamentarios, en buen estado y correctamente colocados durante toda su jornada?</p>
            <div class="q-options">
              <label><input type="radio" name="q1" value="SI"> SI</label>
              <label><input type="radio" name="q1" value="NO"> NO</label>
            </div>
          </li>

          <li class="q-item">
            <p class="q-text">¿Conoce y aplica correctamente los procedimientos operativos establecidos para su puesto específico?</p>
            <div class="q-options">
              <label><input type="radio" name="q2" value="SI"> SI</label>
              <label><input type="radio" name="q2" value="NO"> NO</label>
            </div>
          </li>

          <li class="q-item">
            <p class="q-text">¿Mantiene una actitud vigilante, postura adecuada y atención constante a su entorno?</p>
            <div class="q-options">
              <label><input type="radio" name="q3" value="SI"> SI</label>
              <label><input type="radio" name="q3" value="NO"> NO</label>
            </div>
          </li>

          <li class="q-item">
            <p class="q-text">¿Registra y reporta oportunamente cualquier novedad, incidente o situación fuera de lo común?</p>
            <div class="q-options">
              <label><input type="radio" name="q4" value="SI"> SI</label>
              <label><input type="radio" name="q4" value="NO"> NO</label>
            </div>
          </li>

          <li class="q-item">
            <p class="q-text">¿Cuenta con medios de comunicación operativos y responde de forma oportuna a llamados del supervisor o centro de control?</p>
            <div class="q-options">
              <label><input type="radio" name="q5" value="SI"> SI</label>
              <label><input type="radio" name="q5" value="NO"> NO</label>
            </div>
          </li>

          <li class="q-item">
            <p class="q-text">¿Reportará algo inusual encontrado en el puesto?</p>
            <div class="q-options">
              <label><input type="radio" name="q6" value="SI"> SI</label>
              <label><input type="radio" name="q6" value="NO"> NO</label>
            </div>
            <div class="q6-comment-wrap hidden">
              <textarea id="q6-comment" rows="3" placeholder="Describe brevemente lo inusual..."></textarea>
            </div>
          </li>
        </ol>

        <!-- Evidencia -->
        <div class="evidence-block">
          <label class="evidence-title">Evidencia (opcional)</label>
          <div class="evidence-actions">
            <button type="button" id="btn-evidencia" class="btn btn-warn">TOMAR EVIDENCIA</button>
            <input type="file" id="evidence-input" accept="image/*" capture="environment" hidden />
          </div>
          <div class="evidence-preview" id="evidence-preview-wrap" style="display:none;">
            <img id="evidence-preview" alt="Vista previa evidencia" />
            <button type="button" id="evidence-remove" class="btn">Quitar</button>
          </div>
        </div>

        <button type="submit" class="btn-submit btn btn-primary">Aceptar y Guardar</button>
        <button type="button" class="btn-cancel form-cancel btn">Cancelar</button>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div id="status-toast" class=""></div>

  <!-- Overlay guardado -->
  <div id="saving-overlay" aria-hidden="true">
    <div class="so-backdrop"></div>
    <div class="so-card" role="dialog" aria-live="polite" aria-busy="true">
      <div class="so-spinner" aria-hidden="true"></div>
      <div class="so-check" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="54" height="54">
          <path d="M20 6L9 17l-5-5" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </div>
      <div id="saving-msg" class="so-msg">Guardando…</div>
    </div>
  </div>

  <!-- Mensaje de cámara (INICIAR RONDAS + PLAY) -->
  <div id="camera-permission-msg">
    <div class="msg-box" role="dialog" aria-live="polite" aria-modal="true">
      <h3>INICIAR RONDAS</h3>
      <button id="start-scan-cta" class="btn-play" type="button" aria-label="Iniciar escáner QR">
        <svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true">
          <path d="M8 5v14l11-7z" fill="currentColor"></path>
        </svg>
        <span>PLAY</span>
      </button>
      <p class="hint">Al tocar “PLAY” se solicitará el permiso de cámara.</p>
    </div>
  </div>

  <!-- Sheet de evidencia (Cámara / Galería) -->
  <div id="sheet-evidencia" class="sheet hidden" role="dialog" aria-modal="true">
    <div class="sheet-card">
      <h3>Agregar evidencia</h3>
      <button id="opt-cam" class="btn btn-primary">Abrir cámara</button>
      <button id="opt-gal" class="btn">Adjuntar desde galería</button>
      <button id="opt-cancelar" class="btn btn-ghost">Cancelar</button>
    </div>
  </div>

  <!-- Input de galería adicional -->
  <input id="evidence-input-gallery" type="file" accept="image/*" hidden />

</body>
</html>
