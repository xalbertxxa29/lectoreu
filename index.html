<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Control de Marcaci√≥n</title>

  <link rel="stylesheet" href="style.css" />
  <link rel="manifest" href="manifest.json" />

  <!-- Estilos adicionales -->
  <style>
    .hidden{display:none}
    .questions{margin:10px 0 14px 20px;padding:0}
    .questions li{margin:8px 0 10px;line-height:1.35}
    .questions label{margin-left:10px;margin-right:8px;user-select:none}
    .evidence-preview img{max-width:160px;max-height:160px;border-radius:10px;object-fit:cover}

    /* === Mensaje de permisos de c√°mara === */
    #camera-permission-msg {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.55);
      z-index: 9999;
      text-align: center;
      padding: 20px;
    }
    #camera-permission-msg.active { display: flex; }
    #camera-permission-msg .msg-box {
      background: #fff;
      color: #111;
      padding: 24px 30px;
      border-radius: 14px;
      max-width: 400px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);
      font-family: system-ui, Arial, sans-serif;
    }
    #camera-permission-msg h3 {
      margin-top: 0;
      color: #d62828;
    }
    #camera-permission-msg p {
      margin: 10px 0 0;
      font-size: 15px;
      line-height: 1.5;
    }
  </style>

  <!-- Librer√≠a QR -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js" defer></script>
  <!-- Tu l√≥gica -->
  <script src="script.js" defer></script>
</head>
<body>
  <!-- C√°mara / Scanner -->
  <div id="scanner-container">
    <video id="video" playsinline></video>
    <div id="scan-box-overlay"></div>
    <div class="scanner-header">Apunte al c√≥digo QR</div>
  </div>

  <!-- Canvas oculto -->
  <canvas id="canvas" hidden></canvas>

  <!-- Modal tras escanear -->
  <div id="options-container" class="modal-container" style="display:none;">
    <div class="modal-content">
      <h3>Punto de Marcaci√≥n</h3>
      <p id="scanned-point-name">‚Äî</p>
      <div class="button-group">
        <button id="btn-con-novedad" class="btn-novedad btn btn-warn">CON NOVEDAD</button>
        <button id="btn-sin-novedad" class="btn-normal btn btn-primary">SIN NOVEDAD</button>
      </div>
      <button id="btn-cancel-scan" class="btn-cancel btn">Cancelar</button>
    </div>
  </div>

  <!-- Formulario SIN NOVEDAD -->
  <div id="form-sin-novedad-container" class="modal-container" style="display:none;">
    <div class="modal-content">
      <h3>Registro Sin Novedad</h3>
      <p>Punto: <strong id="point-name-sin-novedad"></strong></p>
      <form id="form-sin-novedad">
        <input type="text" id="agent-name-sin-novedad" placeholder="Ingrese su Nombre y Apellido" required />
        <button type="submit" class="btn-submit btn btn-primary">Aceptar y Guardar</button>
        <button type="button" class="btn-cancel form-cancel btn">Cancelar</button>
      </form>
    </div>
  </div>

  <!-- Formulario CON NOVEDAD -->
  <div id="form-con-novedad-container" class="modal-container" style="display:none;">
    <div class="modal-content">
      <h3>Registro Con Novedad</h3>
      <p>Punto: <strong id="point-name-con-novedad"></strong></p>
      <form id="form-con-novedad">
        <input type="text" id="agent-name-con-novedad" placeholder="Ingrese su Nombre y Apellido" required />
        <textarea id="observation-text" placeholder="Describa la observaci√≥n aqu√≠..." rows="4" required></textarea>

        <ol class="questions">
          <li class="q-item">
            <p class="q-text">¬øEl agente cuenta con todos sus EPPs reglamentarios, en buen estado y correctamente colocados durante toda su jornada?</p>
            <div class="q-options">
              <label><input type="radio" name="q1" value="SI"> SI</label>
              <label><input type="radio" name="q1" value="NO"> NO</label>
            </div>
          </li>

          <li class="q-item">
            <p class="q-text">¬øConoce y aplica correctamente los procedimientos operativos establecidos para su puesto espec√≠fico?</p>
            <div class="q-options">
              <label><input type="radio" name="q2" value="SI"> SI</label>
              <label><input type="radio" name="q2" value="NO"> NO</label>
            </div>
          </li>

          <li class="q-item">
            <p class="q-text">¬øMantiene una actitud vigilante, postura adecuada y atenci√≥n constante a su entorno?</p>
            <div class="q-options">
              <label><input type="radio" name="q3" value="SI"> SI</label>
              <label><input type="radio" name="q3" value="NO"> NO</label>
            </div>
          </li>

          <li class="q-item">
            <p class="q-text">¬øRegistra y reporta oportunamente cualquier novedad, incidente o situaci√≥n fuera de lo com√∫n?</p>
            <div class="q-options">
              <label><input type="radio" name="q4" value="SI"> SI</label>
              <label><input type="radio" name="q4" value="NO"> NO</label>
            </div>
          </li>

          <li class="q-item">
            <p class="q-text">¬øCuenta con medios de comunicaci√≥n operativos y responde de forma oportuna a llamados del supervisor o centro de control?</p>
            <div class="q-options">
              <label><input type="radio" name="q5" value="SI"> SI</label>
              <label><input type="radio" name="q5" value="NO"> NO</label>
            </div>
          </li>

          <li class="q-item">
            <p class="q-text">¬øReportar√° algo inusual encontrado en el puesto?</p>
            <div class="q-options">
              <label><input type="radio" name="q6" value="SI"> SI</label>
              <label><input type="radio" name="q6" value="NO"> NO</label>
            </div>
            <div class="q6-comment-wrap hidden">
              <textarea id="q6-comment" rows="3" placeholder="Describe brevemente lo inusual..."></textarea>
            </div>
          </li>
        </ol>

        <!-- Evidencia -->
        <div class="evidence-block">
          <label class="evidence-title">Evidencia (opcional)</label>
          <div class="evidence-actions">
            <button type="button" id="btn-evidencia" class="btn btn-warn">TOMAR EVIDENCIA</button>
            <input type="file" id="evidence-input" accept="image/*" capture="environment" hidden />
          </div>
          <div class="evidence-preview" id="evidence-preview-wrap" style="display:none;">
            <img id="evidence-preview" alt="Vista previa evidencia" />
            <button type="button" id="evidence-remove" class="btn">Quitar</button>
          </div>
        </div>

        <button type="submit" class="btn-submit btn btn-primary">Aceptar y Guardar</button>
        <button type="button" class="btn-cancel form-cancel btn">Cancelar</button>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div id="status-toast" class=""></div>

  <!-- Overlay guardado -->
  <div id="saving-overlay" aria-hidden="true">
    <div class="so-backdrop"></div>
    <div class="so-card" role="dialog" aria-live="polite" aria-busy="true">
      <div class="so-spinner" aria-hidden="true"></div>
      <div class="so-check" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="54" height="54">
          <path d="M20 6L9 17l-5-5" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </div>
      <div id="saving-msg" class="so-msg">Guardando‚Ä¶</div>
    </div>
  </div>

  <!-- Mensaje de c√°mara -->
  <div id="camera-permission-msg">
    <div class="msg-box">
      <h3>Permiso de C√°mara Requerido</h3>
      <p>Para escanear el c√≥digo QR, por favor permite el acceso a la c√°mara.<br><br>
      Si ves un √≠cono de candado üîí en la barra de direcciones, t√≥cala y selecciona ‚ÄúPermitir c√°mara‚Äù.<br><br>
      Luego, actualiza esta p√°gina.</p>
    </div>
  </div>
</body>
</html>
